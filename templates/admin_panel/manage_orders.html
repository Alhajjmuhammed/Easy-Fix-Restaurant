{% extends 'admin_panel/base.html' %}

{% block title %}Orders Management - Admin Panel{% endblock %}

{% block page_title %}Orders Management{% endblock %}
{% block page_description %}Manage restaurant orders and track order status{% endblock %}

{% block extra_css %}
<style>
    /* Clean Table Styling - Compact Rows */
    .modern-table .table tbody tr {
        border-left: none;
        background-color: transparent;
    }
    
    .modern-table .table tbody tr:hover {
        background-color: rgba(0, 0, 0, 0.05);
    }
    
    /* Table border radius reduction - Override base template */
    .modern-table {
        border-radius: 4px !important;
        overflow: hidden !important;
    }
    
    .modern-table .table {
        border-radius: 4px !important;
        overflow: hidden !important;
    }
    
    .modern-table .table-responsive {
        border-radius: 4px !important;
        overflow: hidden !important;
    }
    
    /* Compact table styling */
    .modern-table .table thead th {
        padding: 0.5rem 0.75rem;
        font-size: 0.8rem;
        font-weight: 600;
    }
    
    .modern-table .table tbody td {
        padding: 0.4rem 0.75rem;
        font-size: 0.85rem;
        vertical-align: middle;
    }
    
    /* Button group styling */
    .btn-group .btn {
        margin-right: 0;
        padding: 0.2rem 0.4rem;
        font-size: 0.75rem;
    }
    
    /* Enhanced Tab Styling */
    .nav-pills .nav-link {
        border-radius: 0.5rem;
        margin-right: 0.5rem;
        padding: 0.75rem 1rem;
        font-weight: 500;
        color: #6c757d;
        border: 1px solid transparent;
        transition: all 0.3s ease;
    }
    
    .nav-pills .nav-link:hover {
        background-color: rgba(13, 110, 253, 0.1);
        color: #0d6efd;
        border-color: rgba(13, 110, 253, 0.2);
    }
    
    .nav-pills .nav-link.active {
        background-color: #0d6efd;
        color: white;
        border-color: #0d6efd;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    
    .nav-pills .nav-link i {
        margin-right: 0.5rem;
    }
    
    .nav-pills .nav-link .badge {
        font-size: 0.65rem;
        padding: 0.25rem 0.5rem;
    }
    
    /* Tab content styling */
    .tab-content {
        margin-top: 1.5rem;
    }
    
    .tab-pane {
        min-height: 400px;
    }
    
    /* Mobile responsive adjustments */
    @media (max-width: 768px) {
        .nav-pills {
            flex-wrap: wrap;
        }
        
        .nav-pills .nav-link {
            margin-bottom: 0.25rem;
            font-size: 0.875rem;
            padding: 0.5rem 0.75rem;
        }
        
        .btn-group {
            flex-direction: column;
        }
        .btn-group .btn {
            margin-bottom: 0.1rem;
            border-radius: 0.25rem !important;
        }
    }
    
    /* Status badge colors */
    .badge.bg-warning { background-color: #ffc107 !important; }
    .badge.bg-info { background-color: #0dcaf0 !important; }
    .badge.bg-primary { background-color: #0d6efd !important; }
    .badge.bg-success { background-color: #198754 !important; }
    .badge.bg-danger { background-color: #dc3545 !important; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="mb-1">Orders Management</h4>
                    <p class="text-muted mb-0">{{ restaurant_name }} - Total Orders: {{ total_count }}</p>
                </div>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addOrderModal">
                    <i class="fas fa-plus"></i> Manual Order Entry
                </button>
            </div>
        </div>
    </div>

    <!-- Status Tabs -->
    <div class="row">
        <div class="col-12">
            <ul class="nav nav-pills mb-3" id="orderStatusTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="pending-tab" data-bs-toggle="pill" data-bs-target="#pending" type="button" role="tab">
                        <i class="fas fa-clock text-warning"></i> Pending
                        {% if pending_count > 0 %}<span class="badge bg-warning text-dark ms-1">{{ pending_count }}</span>{% endif %}
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="confirmed-tab" data-bs-toggle="pill" data-bs-target="#confirmed" type="button" role="tab">
                        <i class="fas fa-check-circle text-info"></i> Confirmed
                        {% if confirmed_count > 0 %}<span class="badge bg-info ms-1">{{ confirmed_count }}</span>{% endif %}
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="preparing-tab" data-bs-toggle="pill" data-bs-target="#preparing" type="button" role="tab">
                        <i class="fas fa-utensils text-primary"></i> Preparing
                        {% if preparing_count > 0 %}<span class="badge bg-primary ms-1">{{ preparing_count }}</span>{% endif %}
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="ready-tab" data-bs-toggle="pill" data-bs-target="#ready" type="button" role="tab">
                        <i class="fas fa-bell text-success"></i> Ready
                        {% if ready_count > 0 %}<span class="badge bg-success ms-1">{{ ready_count }}</span>{% endif %}
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="served-tab" data-bs-toggle="pill" data-bs-target="#served" type="button" role="tab">
                        <i class="fas fa-check text-success"></i> Served
                        {% if served_count > 0 %}<span class="badge bg-success ms-1">{{ served_count }}</span>{% endif %}
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="cancelled-tab" data-bs-toggle="pill" data-bs-target="#cancelled" type="button" role="tab">
                        <i class="fas fa-times text-danger"></i> Cancelled
                        {% if cancelled_count > 0 %}<span class="badge bg-danger ms-1">{{ cancelled_count }}</span>{% endif %}
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="orderStatusTabsContent">
                <!-- Pending Orders Tab -->
                <div class="tab-pane fade show active" id="pending" role="tabpanel">
                    {% include 'admin_panel/partials/orders_table.html' with orders=pending_orders status_name="Pending" %}
                </div>

                <!-- Confirmed Orders Tab -->
                <div class="tab-pane fade" id="confirmed" role="tabpanel">
                    {% include 'admin_panel/partials/orders_table.html' with orders=confirmed_orders status_name="Confirmed" %}
                </div>

                <!-- Preparing Orders Tab -->
                <div class="tab-pane fade" id="preparing" role="tabpanel">
                    {% include 'admin_panel/partials/orders_table.html' with orders=preparing_orders status_name="Preparing" %}
                </div>

                <!-- Ready Orders Tab -->
                <div class="tab-pane fade" id="ready" role="tabpanel">
                    {% include 'admin_panel/partials/orders_table.html' with orders=ready_orders status_name="Ready" %}
                </div>

                <!-- Served Orders Tab -->
                <div class="tab-pane fade" id="served" role="tabpanel">
                    {% include 'admin_panel/partials/orders_table.html' with orders=served_orders status_name="Served" %}
                </div>

                <!-- Cancelled Orders Tab -->
                <div class="tab-pane fade" id="cancelled" role="tabpanel">
                    {% include 'admin_panel/partials/orders_table.html' with orders=cancelled_orders status_name="Cancelled" %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Order Modal -->
<div class="modal fade" id="addOrderModal" tabindex="-1" aria-labelledby="addOrderModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addOrderModalLabel">
                    <i class="fas fa-plus-circle"></i> Manual Order Entry
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="addOrderForm">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="addOrderTable" class="form-label">Table <span class="text-danger">*</span></label>
                        <select class="form-select" id="addOrderTable" name="table_id" required>
                            <option value="">Select Table</option>
                            <!-- Will be populated via AJAX -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="addOrderCustomer" class="form-label">Customer <span class="text-danger">*</span></label>
                        <select class="form-select" id="addOrderCustomer" name="customer_id" required>
                            <option value="">Select Customer</option>
                            <!-- Will be populated via AJAX -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="addOrderInstructions" class="form-label">Special Instructions</label>
                        <textarea class="form-control" id="addOrderInstructions" name="special_instructions" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Add Order
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Order Details Modal -->
<div class="modal fade" id="orderDetailsModal" tabindex="-1" aria-labelledby="orderDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="orderDetailsModalLabel">
                    <i class="fas fa-info-circle"></i> Order Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="orderDetailsContent">
                <!-- Order details will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteOrderModal" tabindex="-1" aria-labelledby="deleteOrderModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteOrderModalLabel">
                    <i class="fas fa-exclamation-triangle text-danger"></i> Confirm Delete
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete <strong id="deleteOrderInfo"></strong>?</p>
                <p class="text-muted mb-0">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteOrder">
                    <i class="fas fa-trash"></i> Delete Order
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // View Order Details
    $('.view-order-btn').on('click', function() {
        const orderId = $(this).data('order-id');
        
        $.ajax({
            url: `{% url "admin_panel:view_order" 0 %}`.replace('0', orderId),
            type: 'GET',
            success: function(response) {
                if (response.success) {
                    $('#orderDetailsContent').html(response.html);
                    $('#orderDetailsModal').modal('show');
                } else {
                    showAlert('danger', response.message || 'Failed to load order details.');
                }
            },
            error: function() {
                showAlert('danger', 'An error occurred while loading order details.');
            }
        });
    });

    // Update Order Status
    $('.update-status-btn').on('click', function() {
        const orderId = $(this).data('order-id');
        const newStatus = $(this).data('status');
        const statusText = newStatus.charAt(0).toUpperCase() + newStatus.slice(1);
        
        if (confirm(`Are you sure you want to update this order status to "${statusText}"?`)) {
            $.ajax({
                url: '{% url "admin_panel:update_order_status" %}',
                type: 'POST',
                data: {
                    'order_id': orderId,
                    'status': newStatus,
                    'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
                },
                success: function(response) {
                    if (response.success) {
                        showAlert('success', response.message);
                        location.reload();
                    } else {
                        showAlert('danger', response.message || 'Failed to update order status.');
                    }
                },
                error: function() {
                    showAlert('danger', 'An error occurred while updating order status.');
                }
            });
        }
    });

    // Add Order Form Submit
    $('#addOrderForm').on('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        $.ajax({
            url: '{% url "admin_panel:add_order" %}',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.success) {
                    $('#addOrderModal').modal('hide');
                    showAlert('success', response.message);
                    location.reload();
                } else {
                    showAlert('danger', response.message);
                }
            },
            error: function() {
                showAlert('danger', 'An error occurred while adding the order.');
            }
        });
    });

    // Delete Order
    $('.delete-order-btn').on('click', function() {
        const orderId = $(this).data('order-id');
        const orderNumber = $(this).data('order-number');
        
        $('#deleteOrderInfo').text(`Order #${orderNumber}`);
        $('#confirmDeleteOrder').data('order-id', orderId);
        $('#deleteOrderModal').modal('show');
    });

    // Confirm Delete Order
    $('#confirmDeleteOrder').on('click', function() {
        const orderId = $(this).data('order-id');
        
        $.ajax({
            url: `{% url "admin_panel:delete_order" 0 %}`.replace('0', orderId),
            type: 'POST',
            data: {
                'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                if (response.success) {
                    $('#deleteOrderModal').modal('hide');
                    showAlert('success', response.message);
                    location.reload();
                } else {
                    showAlert('danger', response.message || 'Failed to delete order.');
                }
            },
            error: function() {
                showAlert('danger', 'An error occurred while deleting the order.');
            }
        });
    });

    // Load tables and customers when add modal opens
    $('#addOrderModal').on('show.bs.modal', function() {
        loadTablesAndCustomers();
    });

    // Load Tables and Customers
    function loadTablesAndCustomers() {
        // Load tables
        $.ajax({
            url: '{% url "admin_panel:manage_tables" %}',
            type: 'GET',
            success: function(data) {
                // This would need an API endpoint to return JSON data
                // For now, we'll populate with static options
                populateTableSelect();
                populateCustomerSelect();
            },
            error: function() {
                console.log('Failed to load tables and customers');
                populateTableSelect();
                populateCustomerSelect();
            }
        });
    }

    function populateTableSelect() {
        const tableSelect = $('#addOrderTable');
        tableSelect.empty();
        tableSelect.append('<option value="">Select Table</option>');
        // You may need to create an API endpoint to get available tables
        // For now, adding sample options
        for (let i = 1; i <= 10; i++) {
            tableSelect.append(`<option value="${i}">Table T${i.toString().padStart(2, '0')}</option>`);
        }
    }

    function populateCustomerSelect() {
        const customerSelect = $('#addOrderCustomer');
        customerSelect.empty();
        customerSelect.append('<option value="">Select Customer</option>');
        // You may need to create an API endpoint to get customers
        // For now, adding sample options
        customerSelect.append('<option value="1">John Doe</option>');
        customerSelect.append('<option value="2">Jane Smith</option>');
    }

    // Clear form when modal is closed
    $('.modal').on('hidden.bs.modal', function() {
        $(this).find('form')[0]?.reset();
    });

    // Show alert function
    function showAlert(type, message) {
        const alertHtml = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
        
        // Remove existing alerts
        $('.alert').remove();
        
        // Add new alert at the top of the container
        $('.container-fluid').prepend(alertHtml);
        
        // Auto-dismiss after 5 seconds
        setTimeout(function() {
            $('.alert').fadeOut();
        }, 5000);
    }
});
</script>

<style>
/* Enhanced Modal Styling */

</style>
{% endblock %}
