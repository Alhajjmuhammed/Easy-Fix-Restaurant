{% extends 'admin_panel/base.html' %}

{% block title %}Categories Management - Admin Panel{% endblock %}

{% block page_title %}Categories Management{% endblock %}
{% block page_description %}Manage menu categories and subcategories{% endblock %}

{% block extra_css %}
<style>
    .nav-tabs .nav-link {
        color: #495057;
        border: 1px solid transparent;
        border-top-left-radius: 0.375rem;
        border-top-right-radius: 0.375rem;
    }
    
    .nav-tabs .nav-link:hover {
        border-color: #e9ecef #e9ecef #dee2e6;
        isolation: isolate;
    }
    
    .nav-tabs .nav-link.active {
        color: #495057;
        background-color: #fff;
        border-color: #dee2e6 #dee2e6 #fff;
    }
    
    .tab-content {
        border: 1px solid #dee2e6;
        border-top: none;
        padding: 1.5rem;
        background-color: #fff;
        border-radius: 0 0 0.375rem 0.375rem;
    }
    
    .category-icon {
        width: 40px;
        height: 40px;
        border-radius: 0.375rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
    }

    .alert-custom {
        animation: slideIn 0.3s ease-in-out;
    }

    @keyframes slideIn {
        from { opacity: 0; transform: translateX(100%); }
        to { opacity: 1; transform: translateX(0); }
    }
</style>
{% endblock %}

{% block content %}
{% csrf_token %}
<!-- Tabs Navigation -->
<ul class="nav nav-tabs" id="categoryTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="main-categories-tab" data-bs-toggle="tab" data-bs-target="#main-categories" type="button" role="tab" aria-controls="main-categories" aria-selected="true">
            <i class="fas fa-folder me-2"></i>Main Categories
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="subcategories-tab" data-bs-toggle="tab" data-bs-target="#subcategories" type="button" role="tab" aria-controls="subcategories" aria-selected="false">
            <i class="fas fa-folder-open me-2"></i>Subcategories
        </button>
    </li>
</ul>

<!-- Tab Content -->
<div class="tab-content" id="categoryTabContent">
    <!-- Main Categories Tab -->
    <div class="tab-pane fade show active" id="main-categories" role="tabpanel" aria-labelledby="main-categories-tab">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addMainCategoryModal">
                <i class="fas fa-plus me-2"></i>Add Main Category
            </button>
            <div class="input-group" style="width: 300px;">
                <span class="input-group-text"><i class="fas fa-search"></i></span>
                <input type="text" class="form-control" placeholder="Search main categories..." id="mainCategorySearchInput">
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Category</th>
                        <th>Description</th>
                        <th>Status</th>
                        <th>Subcategories</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="mainCategoriesTableBody">
                    {% for category in main_categories %}
                    <tr data-category-id="{{ category.id }}">
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="category-icon me-3">
                                    {% if category.image %}
                                        <img src="{{ category.image.url }}" alt="{{ category.name }}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 0.375rem;">
                                    {% else %}
                                        <i class="fas fa-folder"></i>
                                    {% endif %}
                                </div>
                                <div>
                                    <div class="fw-semibold">{{ category.name }}</div>
                                    <small class="text-muted">Main Category</small>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="text-muted">{{ category.description|truncatewords:8|default:"No description provided" }}</span>
                        </td>
                        <td>
                            {% if category.is_active %}
                                <span class="badge bg-success">
                                    <i class="fas fa-check me-1"></i>Active
                                </span>
                            {% else %}
                                <span class="badge bg-secondary">
                                    <i class="fas fa-times me-1"></i>Inactive
                                </span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge bg-info">
                                <i class="fas fa-folder-open me-1"></i>{{ category.subcategories.count }}
                            </span>
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                <button class="btn btn-sm btn-outline-primary edit-main-category-btn" 
                                        data-category-id="{{ category.id }}" 
                                        title="Edit Category">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-warning toggle-main-category-btn" 
                                        data-category-id="{{ category.id }}" 
                                        data-active="{{ category.is_active|yesno:'true,false' }}" 
                                        title="{% if category.is_active %}Deactivate{% else %}Activate{% endif %}">
                                    {% if category.is_active %}
                                        <i class="fas fa-eye-slash"></i>
                                    {% else %}
                                        <i class="fas fa-eye"></i>
                                    {% endif %}
                                </button>
                                <button class="btn btn-sm btn-outline-danger delete-main-category-btn" 
                                        data-category-id="{{ category.id }}" 
                                        data-name="{{ category.name }}" 
                                        title="Delete Category">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center text-muted py-4">
                            <i class="fas fa-folder fa-3x mb-3 d-block text-light"></i>
                            No main categories found
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Subcategories Tab -->
    <div class="tab-pane fade" id="subcategories" role="tabpanel" aria-labelledby="subcategories-tab">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addSubCategoryModal">
                <i class="fas fa-plus me-2"></i>Add Subcategory
            </button>
            <div class="input-group" style="width: 300px;">
                <span class="input-group-text"><i class="fas fa-search"></i></span>
                <input type="text" class="form-control" placeholder="Search subcategories..." id="subcategorySearchInput">
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Subcategory</th>
                        <th>Main Category</th>
                        <th>Description</th>
                        <th>Status</th>
                        <th>Products</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="subcategoriesTableBody">
                    {% for subcategory in subcategories %}
                    <tr data-subcategory-id="{{ subcategory.id }}">
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="category-icon me-3" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                                    {% if subcategory.main_category.image %}
                                        <img src="{{ subcategory.main_category.image.url }}" alt="{{ subcategory.main_category.name }}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 0.375rem;">
                                    {% else %}
                                        <i class="fas fa-folder-open"></i>
                                    {% endif %}
                                </div>
                                <div>
                                    <div class="fw-semibold">{{ subcategory.name }}</div>
                                    <small class="text-muted">Subcategory</small>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="badge bg-primary">
                                {% if subcategory.main_category.image %}
                                    <img src="{{ subcategory.main_category.image.url }}" alt="{{ subcategory.main_category.name }}" style="width: 16px; height: 16px; object-fit: cover; border-radius: 2px;" class="me-1">
                                {% else %}
                                    <i class="fas fa-folder me-1"></i>
                                {% endif %}
                                {{ subcategory.main_category.name }}
                            </span>
                        </td>
                        <td>
                            <span class="text-muted">{{ subcategory.description|truncatewords:8|default:"No description provided" }}</span>
                        </td>
                        <td>
                            {% if subcategory.is_active %}
                                <span class="badge bg-success">
                                    <i class="fas fa-check me-1"></i>Active
                                </span>
                            {% else %}
                                <span class="badge bg-secondary">
                                    <i class="fas fa-times me-1"></i>Inactive
                                </span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge bg-info">
                                <i class="fas fa-utensils me-1"></i>{{ subcategory.products.count }}
                            </span>
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                <button class="btn btn-sm btn-outline-primary edit-subcategory-btn" 
                                        data-subcategory-id="{{ subcategory.id }}" 
                                        title="Edit Subcategory">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-warning toggle-subcategory-btn" 
                                        data-subcategory-id="{{ subcategory.id }}" 
                                        data-active="{{ subcategory.is_active|yesno:'true,false' }}" 
                                        title="{% if subcategory.is_active %}Deactivate{% else %}Activate{% endif %}">
                                    {% if subcategory.is_active %}
                                        <i class="fas fa-eye-slash"></i>
                                    {% else %}
                                        <i class="fas fa-eye"></i>
                                    {% endif %}
                                </button>
                                <button class="btn btn-sm btn-outline-danger delete-subcategory-btn" 
                                        data-subcategory-id="{{ subcategory.id }}" 
                                        data-name="{{ subcategory.name }}" 
                                        title="Delete Subcategory">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center text-muted py-4">
                            <i class="fas fa-folder-open fa-3x mb-3 d-block text-light"></i>
                            No subcategories found
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Main Category Modal -->
<div class="modal fade" id="addMainCategoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-folder me-2"></i>Add Main Category
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addMainCategoryForm" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="mainCategoryName" class="form-label">Category Name</label>
                        <input type="text" class="form-control" id="mainCategoryName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="mainCategoryDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="mainCategoryDescription" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="mainCategoryImage" class="form-label">Category Image</label>
                        <input type="file" class="form-control" id="mainCategoryImage" name="image" accept="image/*">
                        <div class="form-text">Upload an image for this category (JPG, PNG, GIF - Max: 5MB)</div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="mainCategoryActive" name="is_active" checked>
                            <label class="form-check-label" for="mainCategoryActive">
                                Active Category
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-plus me-1"></i>Add Category
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Main Category Modal -->
<div class="modal fade" id="editMainCategoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>Edit Main Category
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editMainCategoryForm" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <input type="hidden" id="editMainCategoryId" name="category_id">
                    <div class="mb-3">
                        <label for="editMainCategoryName" class="form-label">Category Name</label>
                        <input type="text" class="form-control" id="editMainCategoryName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="editMainCategoryDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="editMainCategoryDescription" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="editMainCategoryImage" class="form-label">Category Image</label>
                        <input type="file" class="form-control" id="editMainCategoryImage" name="image" accept="image/*">
                        <div class="form-text">Upload a new image to replace the current one (optional)</div>
                        <div id="currentImagePreview" style="margin-top: 10px;"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i>Update Category
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Subcategory Modal -->
<div class="modal fade" id="addSubCategoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-folder-open me-2"></i>Add Subcategory
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addSubCategoryForm">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="subCategoryMainCategory" class="form-label">Main Category</label>
                        <select class="form-select" id="subCategoryMainCategory" name="main_category" required>
                            <option value="">Select Main Category</option>
                            {% for category in main_categories %}
                            {% if category.is_active %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="subCategoryName" class="form-label">Subcategory Name</label>
                        <input type="text" class="form-control" id="subCategoryName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="subCategoryDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="subCategoryDescription" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="subCategoryActive" name="is_active" checked>
                            <label class="form-check-label" for="subCategoryActive">
                                Active Subcategory
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-plus me-1"></i>Add Subcategory
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Subcategory Modal -->
<div class="modal fade" id="editSubCategoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>Edit Subcategory
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editSubCategoryForm">
                {% csrf_token %}
                <div class="modal-body">
                    <input type="hidden" id="editSubCategoryId" name="subcategory_id">
                    <div class="mb-3">
                        <label for="editSubCategoryMainCategory" class="form-label">Main Category</label>
                        <select class="form-select" id="editSubCategoryMainCategory" name="main_category" required>
                            <option value="">Select Main Category</option>
                            {% for category in main_categories %}
                            {% if category.is_active %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editSubCategoryName" class="form-label">Subcategory Name</label>
                        <input type="text" class="form-control" id="editSubCategoryName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="editSubCategoryDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="editSubCategoryDescription" name="description" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i>Update Subcategory
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Prevent multiple submissions and handle events properly
let isProcessing = false;

// CSRF Token for AJAX requests
function getCSRFToken() {
    const token = document.querySelector('[name=csrfmiddlewaretoken]');
    return token ? token.value : '{{ csrf_token }}';
}

// Show alert function with proper cleanup
function showAlert(message, type = 'success') {
    // Remove any existing alerts
    const existingAlerts = document.querySelectorAll('.alert-custom');
    existingAlerts.forEach(alert => alert.remove());
    
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed alert-custom`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 1055; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// Prevent double execution
function executeOnce(fn, context = null) {
    if (isProcessing) return;
    isProcessing = true;
    
    const result = fn.call(context);
    
    // Reset processing flag after operation
    setTimeout(() => {
        isProcessing = false;
    }, 1000);
    
    return result;
}

// Form submission with proper error handling
function submitForm(form, url, successMessage, redirectOnSuccess = true) {
    if (isProcessing) return Promise.resolve(false);
    
    const formData = new FormData(form);
    
    return fetch(url, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message || successMessage, 'success');
            // Close the modal properly
            const modal = bootstrap.Modal.getInstance(form.closest('.modal'));
            if (modal) {
                modal.hide();
            }
            if (redirectOnSuccess) {
                setTimeout(() => {
                    location.reload();
                }, 1500);
            }
            return true;
        } else {
            showAlert(data.message || 'Operation failed', 'danger');
            return false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Network error occurred', 'danger');
        return false;
    });
}

// Category management functions
function editMainCategory(categoryId) {
    const row = document.querySelector(`[data-category-id="${categoryId}"]`);
    if (row) {
        const nameElement = row.querySelector('.fw-semibold');
        const descElement = row.querySelector('.text-muted');
        
        document.getElementById('editMainCategoryId').value = categoryId;
        document.getElementById('editMainCategoryName').value = nameElement ? nameElement.textContent.trim() : '';
        
        // Handle description - filter out "No description provided"
        let description = '';
        if (descElement && descElement.textContent.trim() !== 'No description provided') {
            description = descElement.textContent.trim();
        }
        document.getElementById('editMainCategoryDescription').value = description;
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('editMainCategoryModal'));
        modal.show();
    }
}

function editSubcategory(subcategoryId) {
    const row = document.querySelector(`[data-subcategory-id="${subcategoryId}"]`);
    if (row) {
        const nameElement = row.querySelector('.fw-semibold');
        const descElement = row.querySelector('.text-muted');
        const mainCategoryElement = row.querySelector('.badge.bg-primary');
        
        document.getElementById('editSubCategoryId').value = subcategoryId;
        document.getElementById('editSubCategoryName').value = nameElement ? nameElement.textContent.trim() : '';
        
        // Handle description
        let description = '';
        if (descElement && descElement.textContent.trim() !== 'No description provided') {
            description = descElement.textContent.trim();
        }
        document.getElementById('editSubCategoryDescription').value = description;
        
        // Set main category - match by name to value
        if (mainCategoryElement) {
            const mainCategoryName = mainCategoryElement.textContent.replace(/.*\s/, '').trim();
            const select = document.getElementById('editSubCategoryMainCategory');
            for (let option of select.options) {
                if (option.text === mainCategoryName) {
                    select.value = option.value;
                    break;
                }
            }
        }
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('editSubCategoryModal'));
        modal.show();
    }
}

function deleteMainCategory(categoryId, categoryName) {
    executeOnce(() => {
        if (confirm(`Are you sure you want to delete the category "${categoryName}"?\n\nWARNING: This will also delete ALL subcategories and products in this category.\nThis action cannot be undone.`)) {
            fetch(`/admin-panel/categories/delete-main/${categoryId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCSRFToken(),
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert(data.message, 'success');
                    // Remove category row from table
                    const categoryRow = document.querySelector(`[data-category-id="${categoryId}"]`);
                    if (categoryRow) {
                        categoryRow.remove();
                    }
                } else {
                    showAlert(data.message || 'Failed to delete category', 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('Failed to delete category', 'danger');
            });
        }
    });
}

function deleteSubcategory(subcategoryId, subcategoryName) {
    executeOnce(() => {
        if (confirm(`Are you sure you want to delete the subcategory "${subcategoryName}"?\n\nWARNING: This will also delete ALL products in this subcategory.\nThis action cannot be undone.`)) {
            fetch(`/admin-panel/categories/delete-sub/${subcategoryId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCSRFToken(),
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert(data.message, 'success');
                    // Remove subcategory row from table
                    const subcategoryRow = document.querySelector(`[data-subcategory-id="${subcategoryId}"]`);
                    if (subcategoryRow) {
                        subcategoryRow.remove();
                    }
                } else {
                    showAlert(data.message || 'Failed to delete subcategory', 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('Failed to delete subcategory', 'danger');
            });
        }
    });
}

function toggleMainCategory(categoryId, isActive) {
    executeOnce(() => {
        const action = isActive ? 'deactivate' : 'activate';
        
        if (confirm(`Are you sure you want to ${action} this category?`)) {
            fetch(`/admin-panel/categories/toggle-main/${categoryId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCSRFToken(),
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert(data.message, 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    showAlert(data.message || 'Failed to update category status', 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('Failed to update category status', 'danger');
            });
        }
    });
}

function toggleSubcategory(subcategoryId, isActive) {
    executeOnce(() => {
        const action = isActive ? 'deactivate' : 'activate';
        
        if (confirm(`Are you sure you want to ${action} this subcategory?`)) {
            fetch(`/admin-panel/categories/toggle-sub/${subcategoryId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCSRFToken(),
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert(data.message, 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    showAlert(data.message || 'Failed to update subcategory status', 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('Failed to update subcategory status', 'danger');
            });
        }
    });
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    // Single event delegation handler
    document.addEventListener('click', function(e) {
        // Prevent multiple rapid clicks
        if (isProcessing) {
            e.preventDefault();
            return;
        }

        // Edit main category buttons
        if (e.target.closest('.edit-main-category-btn')) {
            e.preventDefault();
            const button = e.target.closest('.edit-main-category-btn');
            const categoryId = button.dataset.categoryId;
            editMainCategory(categoryId);
        }
        
        // Edit subcategory buttons
        else if (e.target.closest('.edit-subcategory-btn')) {
            e.preventDefault();
            const button = e.target.closest('.edit-subcategory-btn');
            const subcategoryId = button.dataset.subcategoryId;
            editSubcategory(subcategoryId);
        }
        
        // Toggle main category buttons
        else if (e.target.closest('.toggle-main-category-btn')) {
            e.preventDefault();
            const button = e.target.closest('.toggle-main-category-btn');
            const categoryId = button.dataset.categoryId;
            const isActive = button.dataset.active === 'true';
            toggleMainCategory(categoryId, isActive);
        }
        
        // Toggle subcategory buttons
        else if (e.target.closest('.toggle-subcategory-btn')) {
            e.preventDefault();
            const button = e.target.closest('.toggle-subcategory-btn');
            const subcategoryId = button.dataset.subcategoryId;
            const isActive = button.dataset.active === 'true';
            toggleSubcategory(subcategoryId, isActive);
        }
        
        // Delete main category buttons
        else if (e.target.closest('.delete-main-category-btn')) {
            e.preventDefault();
            const button = e.target.closest('.delete-main-category-btn');
            const categoryId = button.dataset.categoryId;
            const categoryName = button.dataset.name;
            deleteMainCategory(categoryId, categoryName);
        }
        
        // Delete subcategory buttons
        else if (e.target.closest('.delete-subcategory-btn')) {
            e.preventDefault();
            const button = e.target.closest('.delete-subcategory-btn');
            const subcategoryId = button.dataset.subcategoryId;
            const subcategoryName = button.dataset.name;
            deleteSubcategory(subcategoryId, subcategoryName);
        }
    });

    // Form submissions
    const addMainCategoryForm = document.getElementById('addMainCategoryForm');
    if (addMainCategoryForm) {
        addMainCategoryForm.addEventListener('submit', function(e) {
            e.preventDefault();
            if (!isProcessing) {
                submitForm(this, '/admin-panel/categories/add-main/', 'Main category added successfully');
            }
        });
    }

    const editMainCategoryForm = document.getElementById('editMainCategoryForm');
    if (editMainCategoryForm) {
        editMainCategoryForm.addEventListener('submit', function(e) {
            e.preventDefault();
            if (!isProcessing) {
                const categoryId = document.getElementById('editMainCategoryId').value;
                submitForm(this, `/admin-panel/categories/edit-main/${categoryId}/`, 'Main category updated successfully');
            }
        });
    }

    const addSubCategoryForm = document.getElementById('addSubCategoryForm');
    if (addSubCategoryForm) {
        addSubCategoryForm.addEventListener('submit', function(e) {
            e.preventDefault();
            if (!isProcessing) {
                submitForm(this, '/admin-panel/categories/add-sub/', 'Subcategory added successfully');
            }
        });
    }

    const editSubCategoryForm = document.getElementById('editSubCategoryForm');
    if (editSubCategoryForm) {
        editSubCategoryForm.addEventListener('submit', function(e) {
            e.preventDefault();
            if (!isProcessing) {
                const subcategoryId = document.getElementById('editSubCategoryId').value;
                submitForm(this, `/admin-panel/categories/edit-sub/${subcategoryId}/`, 'Subcategory updated successfully');
            }
        });
    }

    // Search functionality for main categories
    const mainCategorySearchInput = document.getElementById('mainCategorySearchInput');
    if (mainCategorySearchInput) {
        mainCategorySearchInput.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const tableRows = document.querySelectorAll('#mainCategoriesTableBody tr');
            
            tableRows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
    }

    // Search functionality for subcategories
    const subcategorySearchInput = document.getElementById('subcategorySearchInput');
    if (subcategorySearchInput) {
        subcategorySearchInput.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const tableRows = document.querySelectorAll('#subcategoriesTableBody tr');
            
            tableRows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
    }

    // Modal event handlers to reset forms and prevent issues
    const modals = ['addMainCategoryModal', 'editMainCategoryModal', 'addSubCategoryModal', 'editSubCategoryModal'];
    
    modals.forEach(modalId => {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.addEventListener('hidden.bs.modal', function() {
                // Reset form and clear processing flag
                const form = this.querySelector('form');
                if (form) {
                    form.reset();
                }
                isProcessing = false;
            });
            
            modal.addEventListener('shown.bs.modal', function() {
                // Clear processing flag when modal opens
                isProcessing = false;
            });
        }
    });
});
</script>
{% endblock %}
