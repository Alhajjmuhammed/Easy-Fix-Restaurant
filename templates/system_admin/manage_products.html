{% extends 'system_admin/base.html' %}
{% load static %}

{% block title %}Manage Products - System Admin{% endblock %}

{% block extra_css %}
<style>
.product-card {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    margin-bottom: 15px;
    transition: box-shadow 0.2s;
    background: white;
}

.product-card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.product-header {
    padding: 15px;
    border-bottom: 1px solid #dee2e6;
}

.product-body {
    padding: 15px;
}

.product-image {
    width: 50px;
    height: 50px;
    object-fit: cover;
    border-radius: 6px;
    margin-right: 15px;
}

.price-badge {
    background-color: #28a745;
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-weight: bold;
}

.availability-badge {
    font-size: 0.8em;
}

.restaurant-badge {
    background-color: #6c757d;
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.8em;
}

.category-badge {
    background-color: #007bff;
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.8em;
    margin-right: 5px;
}

.filters-card {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
}

/* Product Image Styles */
.product-image {
    width: 50px !important;
    height: 50px !important;
    object-fit: cover;
    border-radius: 6px;
    border: 1px solid #dee2e6;
    max-width: 50px !important;
    max-height: 50px !important;
}

.product-table-image {
    width: 50px !important;
    height: 50px !important;
    border-radius: 6px;
    object-fit: cover;
    border: 1px solid #dee2e6;
    max-width: 50px !important;
    max-height: 50px !important;
}

.no-image-placeholder {
    width: 50px !important;
    height: 50px !important;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #f8f9fa;
}

.no-image-placeholder-card {
    width: 50px !important;
    height: 50px !important;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #f8f9fa;
    flex-shrink: 0;
    margin-right: 10px;
}
    height: 50px;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #f8f9fa;
    flex-shrink: 0;
    margin-right: 10px;
}

.current-product-image {
    max-width: 200px;
    max-height: 150px;
    border-radius: 8px;
    border: 1px solid #dee2e6;
    object-fit: cover;
}

.no-image-placeholder-large {
    width: 200px;
    height: 150px;
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background-color: #f8f9fa;
    color: #6c757d;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2><i class="fas fa-utensils"></i> Manage Products</h2>
                    <p class="text-muted">System-wide product management for all restaurants</p>
                </div>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createProductModal">
                    <i class="fas fa-plus"></i> Add Product
                </button>
            </div>

            <!-- Filters -->
            <div class="card filters-card mb-4">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <label for="restaurantFilter" class="form-label">Filter by Restaurant:</label>
                            <select class="form-select" id="restaurantFilter" onchange="filterByRestaurant()">
                                <option value="">All Restaurants</option>
                                {% for restaurant in restaurants %}
                                <option value="{{ restaurant.id }}" {% if selected_restaurant and selected_restaurant.id == restaurant.id %}selected{% endif %}>
                                    {{ restaurant.restaurant_name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="categoryFilter" class="form-label">Filter by Category:</label>
                            <select class="form-select" id="categoryFilter" onchange="filterByCategory()">
                                <option value="">All Categories</option>
                                {% for category in categories %}
                                <option value="{{ category.id }}" {% if selected_category and selected_category.id == category.id %}selected{% endif %}>
                                    {{ category.name }}
                                    {% if not selected_restaurant %} ({{ category.owner.restaurant_name }}){% endif %}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <div class="me-3">
                                <div class="btn-group" role="group" aria-label="View toggle">
                                    <button type="button" class="btn btn-outline-secondary btn-sm" id="cardView" onclick="switchView('card')">
                                        <i class="fas fa-th-large"></i> Cards
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm active" id="tableView" onclick="switchView('table')">
                                        <i class="fas fa-table"></i> Table
                                    </button>
                                </div>
                            </div>
                            <div class="text-muted">
                                Showing {{ products.count }} products
                                {% if selected_restaurant %}for {{ selected_restaurant.restaurant_name }}{% endif %}
                                {% if selected_category %}in {{ selected_category.name }}{% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Products List -->
            <!-- Card View -->
            <div class="row" id="cardViewContainer" style="display: none;">
                {% for product in products %}
                <div class="col-md-6 col-lg-4">
                    <div class="product-card">
                        <div class="product-header">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="d-flex align-items-start flex-grow-1">
                                    <!-- Small thumbnail image -->
                                    <div class="me-3">
                                        {% if product.image %}
                                        <img src="{{ product.image.url }}" alt="{{ product.name }}" class="product-image" style="width: 50px; height: 50px; object-fit: cover; border-radius: 6px;">
                                        {% else %}
                                        <div class="no-image-placeholder-card" style="width: 50px; height: 50px;">
                                            <i class="fas fa-image text-muted"></i>
                                        </div>
                                        {% endif %}
                                    </div>
                                    <!-- Product details -->
                                    <div class="flex-grow-1">
                                        <h5 class="mb-1">{{ product.name }}</h5>
                                        <div class="mb-2">
                                            <span class="restaurant-badge">{{ product.main_category.owner.restaurant_name }}</span>
                                        </div>
                                        <div class="mb-2">
                                            <span class="category-badge">{{ product.main_category.name }}</span>
                                            {% if product.sub_category %}
                                            <span class="badge bg-secondary">{{ product.sub_category.name }}</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="#" onclick="viewProductDetails({{ product.id }})">
                                            <i class="fas fa-eye"></i> View Details
                                        </a></li>
                                        <li><a class="dropdown-item" href="#" onclick="editProduct({{ product.id }})">
                                            <i class="fas fa-edit"></i> Edit
                                        </a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item text-danger" href="#" onclick="deleteProduct({{ product.id }}, '{{ product.name }}', '{{ product.main_category.owner.restaurant_name }}')">
                                            <i class="fas fa-trash"></i> Delete
                                        </a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="product-body">
                            <p class="text-muted mb-2">{{ product.description|default:"No description"|truncatechars:100 }}</p>
                            
                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <span class="price-badge">${{ product.price }}</span>
                                <span class="badge availability-badge {% if product.is_available %}bg-success{% else %}bg-danger{% endif %}">
                                    {% if product.is_available %}Available{% else %}Unavailable{% endif %}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="col-12">
                    <div class="text-center py-5">
                        <i class="fas fa-utensils fa-3x text-muted mb-3"></i>
                        <h4 class="text-muted">No Products Found</h4>
                        <p class="text-muted">
                            {% if selected_restaurant %}
                                No products found for {{ selected_restaurant.restaurant_name }}.
                            {% elif selected_category %}
                                No products found in {{ selected_category.name }}.
                            {% else %}
                                No products found in the system.
                            {% endif %}
                        </p>
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createProductModal">
                            <i class="fas fa-plus"></i> Create First Product
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Table View -->
            <div id="tableViewContainer">
                {% if products %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>SN</th>
                                <th>Image</th>
                                <th>Name</th>
                                <th>Restaurant</th>
                                <th>Category</th>
                                <th>Sub Category</th>
                                <th>Price</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for product in products %}
                            <tr>
                                <td>{{ forloop.counter }}</td>
                                <td>
                                    {% if product.image %}
                                    <img src="{{ product.image.url }}" alt="{{ product.name }}" class="product-table-image" style="width: 50px; height: 50px; object-fit: cover; border-radius: 6px;">
                                    {% else %}
                                    <div class="no-image-placeholder" style="width: 50px; height: 50px;">
                                        <i class="fas fa-image text-muted"></i>
                                    </div>
                                    {% endif %}
                                </td>
                                <td>
                                    <strong>{{ product.name }}</strong>
                                    {% if product.description %}
                                    <br><small class="text-muted">{{ product.description|truncatechars:60 }}</small>
                                    {% endif %}
                                </td>
                                <td>{{ product.main_category.owner.restaurant_name }}</td>
                                <td>{{ product.main_category.name }}</td>
                                <td>{{ product.sub_category.name|default:"None" }}</td>
                                <td>
                                    <span class="badge bg-success">${{ product.price }}</span>
                                </td>
                                <td>
                                    <span class="badge {% if product.is_available %}bg-success{% else %}bg-danger{% endif %}">
                                        {% if product.is_available %}Available{% else %}Unavailable{% endif %}
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-info" onclick="viewProductDetails({{ product.id }})" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-warning" onclick="editProduct({{ product.id }})" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct({{ product.id }}, '{{ product.name }}', '{{ product.main_category.owner.restaurant_name }}')" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-utensils fa-3x text-muted mb-3"></i>
                    <h4 class="text-muted">No Products Found</h4>
                    <p class="text-muted">
                        {% if selected_restaurant %}
                            No products found for {{ selected_restaurant.restaurant_name }}.
                        {% elif selected_category %}
                            No products found in {{ selected_category.name }}.
                        {% else %}
                            No products found in the system.
                        {% endif %}
                    </p>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createProductModal">
                        <i class="fas fa-plus"></i> Create First Product
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Create Product Modal -->
<div class="modal fade" id="createProductModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="createProductForm">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="createRestaurant" class="form-label">Restaurant *</label>
                        <select class="form-select" id="createRestaurant" name="restaurant" required onchange="loadMainCategories('create')">
                            <option value="">Select Restaurant</option>
                            {% for restaurant in restaurants %}
                            <option value="{{ restaurant.id }}">{{ restaurant.restaurant_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="createMainCategory" class="form-label">Main Category *</label>
                        <select class="form-select" id="createMainCategory" name="main_category" required onchange="loadSubCategories('create')">
                            <option value="">Select Main Category</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="createSubCategory" class="form-label">Sub Category</label>
                        <select class="form-select" id="createSubCategory" name="sub_category">
                            <option value="">Select Sub Category (Optional)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="createName" class="form-label">Product Name *</label>
                        <input type="text" class="form-control" id="createName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="createDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="createDescription" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="createPrice" class="form-label">Price *</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" id="createPrice" name="price" step="0.01" min="0" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="createAvailability" name="availability" checked>
                            <label class="form-check-label" for="createAvailability">
                                Available for ordering
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Product</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Product Modal -->
<div class="modal fade" id="editProductModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editProductForm">
                {% csrf_token %}
                <input type="hidden" id="editProductId" name="product_id">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Restaurant</label>
                        <input type="text" class="form-control" id="editRestaurantName" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Main Category</label>
                        <input type="text" class="form-control" id="editMainCategoryName" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Sub Category</label>
                        <input type="text" class="form-control" id="editSubCategoryName" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Current Image</label>
                        <div id="editCurrentImageContainer" style="display: none;">
                            <img id="editCurrentImage" src="" alt="Product Image" class="current-product-image mb-2">
                            <br><small class="text-muted">Current product image</small>
                        </div>
                        <div id="editNoImageMessage" style="display: none;">
                            <div class="no-image-placeholder-large">
                                <i class="fas fa-image text-muted"></i>
                                <br><small class="text-muted">No image uploaded</small>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editName" class="form-label">Product Name *</label>
                        <input type="text" class="form-control" id="editName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="editDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="editDescription" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="editPrice" class="form-label">Price *</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" id="editPrice" name="price" step="0.01" min="0" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="editAvailability" name="availability">
                            <label class="form-check-label" for="editAvailability">
                                Available for ordering
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Product</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Product Details Modal -->
<div class="modal fade" id="productDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Product Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="productDetailsContent">
                <!-- Content loaded via AJAX -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Filter functions
function filterByRestaurant() {
    const restaurantId = document.getElementById('restaurantFilter').value;
    const currentUrl = new URL(window.location.href);
    
    if (restaurantId) {
        currentUrl.searchParams.set('restaurant', restaurantId);
    } else {
        currentUrl.searchParams.delete('restaurant');
    }
    currentUrl.searchParams.delete('category'); // Reset category filter
    
    window.location.href = currentUrl.toString();
}

function filterByCategory() {
    const categoryId = document.getElementById('categoryFilter').value;
    const currentUrl = new URL(window.location.href);
    
    if (categoryId) {
        currentUrl.searchParams.set('category', categoryId);
    } else {
        currentUrl.searchParams.delete('category');
    }
    
    window.location.href = currentUrl.toString();
}

// Load main categories based on restaurant selection
async function loadMainCategories(prefix) {
    const restaurantId = document.getElementById(`${prefix}Restaurant`).value;
    const mainCategorySelect = document.getElementById(`${prefix}MainCategory`);
    const subCategorySelect = document.getElementById(`${prefix}SubCategory`);
    
    // Clear existing options
    mainCategorySelect.innerHTML = '<option value="">Select Main Category</option>';
    subCategorySelect.innerHTML = '<option value="">Select Sub Category (Optional)</option>';
    
    if (!restaurantId) return;
    
    try {
        const response = await fetch(`{% url "system_admin:get_categories" 0 %}`.replace('0', restaurantId));
        
        // Check if the response is ok
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        // Check if response is JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const textResponse = await response.text();
            console.error('Expected JSON but got:', textResponse);
            throw new Error('Server returned non-JSON response');
        }
        
        const result = await response.json();
        
        if (result.success) {
            result.categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                mainCategorySelect.appendChild(option);
            });
        } else {
            console.error('Failed to load categories:', result.message);
            showAlert('warning', 'Could not load categories: ' + result.message);
        }
    } catch (error) {
        console.error('Error loading categories:', error);
        showAlert('warning', 'Could not load categories: ' + error.message);
    }
}

// Load subcategories based on main category selection
async function loadSubCategories(prefix) {
    const categoryId = document.getElementById(`${prefix}MainCategory`).value;
    const subCategorySelect = document.getElementById(`${prefix}SubCategory`);
    
    // Clear existing options
    subCategorySelect.innerHTML = '<option value="">Select Sub Category (Optional)</option>';
    
    if (!categoryId) return;
    
    try {
        const response = await fetch(`{% url "system_admin:get_subcategories" 0 %}`.replace('0', categoryId));
        
        // Check if the response is ok
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        // Check if response is JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const textResponse = await response.text();
            console.error('Expected JSON but got:', textResponse);
            throw new Error('Server returned non-JSON response');
        }
        
        const result = await response.json();
        
        if (result.success) {
            result.subcategories.forEach(subcategory => {
                const option = document.createElement('option');
                option.value = subcategory.id;
                option.textContent = subcategory.name;
                subCategorySelect.appendChild(option);
            });
        } else {
            console.error('Failed to load subcategories:', result.message);
        }
    } catch (error) {
        console.error('Error loading subcategories:', error);
        showAlert('warning', 'Could not load subcategories: ' + error.message);
    }
}

// Create product
document.getElementById('createProductForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {
        main_category: formData.get('main_category'),
        sub_category: formData.get('sub_category') || null,
        name: formData.get('name'),
        description: formData.get('description'),
        price: formData.get('price'),
        availability: formData.has('availability')
    };
    
    try {
        const response = await fetch('{% url "system_admin:create_product" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('success', result.message);
            bootstrap.Modal.getInstance(document.getElementById('createProductModal')).hide();
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showAlert('danger', result.message);
        }
    } catch (error) {
        showAlert('danger', 'Error creating product: ' + error.message);
    }
});

// Edit product
async function editProduct(productId) {
    try {
        const response = await fetch(`{% url "system_admin:edit_product" 0 %}`.replace('0', productId));
        
        // Check if the response is ok
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        // Check if response is JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const textResponse = await response.text();
            console.error('Expected JSON but got:', textResponse);
            throw new Error('Server returned non-JSON response');
        }
        
        const data = await response.json();
        
        // Check if the response has the expected structure
        if (!data.id) {
            throw new Error('Invalid product data received');
        }
        
        document.getElementById('editProductId').value = data.id;
        document.getElementById('editName').value = data.name;
        document.getElementById('editDescription').value = data.description;
        document.getElementById('editPrice').value = data.price;
        document.getElementById('editAvailability').checked = data.availability;
        document.getElementById('editRestaurantName').value = data.restaurant_name;
        document.getElementById('editMainCategoryName').value = data.main_category_name;
        document.getElementById('editSubCategoryName').value = data.sub_category_name || 'None';
        
        // Handle product image display
        const currentImageContainer = document.getElementById('editCurrentImageContainer');
        const noImageMessage = document.getElementById('editNoImageMessage');
        const currentImage = document.getElementById('editCurrentImage');
        
        if (data.image_url) {
            currentImage.src = data.image_url;
            currentImageContainer.style.display = 'block';
            noImageMessage.style.display = 'none';
        } else {
            currentImageContainer.style.display = 'none';
            noImageMessage.style.display = 'block';
        }
        
        new bootstrap.Modal(document.getElementById('editProductModal')).show();
    } catch (error) {
        console.error('Edit product error:', error);
        showAlert('danger', 'Error loading product data: ' + error.message);
    }
}

document.getElementById('editProductForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const productId = document.getElementById('editProductId').value;
    const formData = new FormData(this);
    const data = {
        name: formData.get('name'),
        description: formData.get('description'),
        price: formData.get('price'),
        availability: formData.has('availability')
    };
    
    try {
        const response = await fetch(`{% url "system_admin:edit_product" 0 %}`.replace('0', productId), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('success', result.message);
            bootstrap.Modal.getInstance(document.getElementById('editProductModal')).hide();
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showAlert('danger', result.message);
        }
    } catch (error) {
        showAlert('danger', 'Error updating product: ' + error.message);
    }
});

// Delete product
async function deleteProduct(productId, productName, restaurantName) {
    if (!confirm(`Are you sure you want to delete the product "${productName}" from ${restaurantName}?\n\nThis action cannot be undone.`)) {
        return;
    }
    
    try {
        const response = await fetch(`{% url "system_admin:delete_product" 0 %}`.replace('0', productId), {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('success', result.message);
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showAlert('danger', result.message);
        }
    } catch (error) {
        showAlert('danger', 'Error deleting product: ' + error.message);
    }
}

// View product details
async function viewProductDetails(productId) {
    try {
        const response = await fetch(`{% url "system_admin:product_details" 0 %}`.replace('0', productId));
        const html = await response.text();
        
        document.getElementById('productDetailsContent').innerHTML = html;
        new bootstrap.Modal(document.getElementById('productDetailsModal')).show();
    } catch (error) {
        showAlert('danger', 'Error loading product details: ' + error.message);
    }
}

// View switching function
function switchView(viewType) {
    const cardView = document.getElementById('cardViewContainer');
    const tableView = document.getElementById('tableViewContainer');
    const cardBtn = document.getElementById('cardView');
    const tableBtn = document.getElementById('tableView');
    
    if (viewType === 'card') {
        cardView.style.display = 'flex';
        tableView.style.display = 'none';
        cardBtn.classList.add('active');
        tableBtn.classList.remove('active');
    } else {
        cardView.style.display = 'none';
        tableView.style.display = 'block';
        tableBtn.classList.add('active');
        cardBtn.classList.remove('active');
    }
}

// Alert function
function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.querySelector('.container-fluid').insertBefore(alertDiv, document.querySelector('.row'));
    
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}
</script>
{% endblock %}