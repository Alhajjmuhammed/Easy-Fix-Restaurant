{% extends 'cashier_base.html' %}
{% load static %}

{% block title %}Cashier Dashboard{% endblock %}

{% block extra_css %}
<style>
    /* Clean Mobile Header Toggle Styles */
    @media (max-width: 768px) {
        .mobile-header {
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 0.75rem;
            margin-bottom: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .header-toggle {
            background: none;
            border: 1px solid #dee2e6;
            color: #6c757d;
            padding: 0.375rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.9rem;
        }
        
        .header-toggle:hover {
            background: #f8f9fa;
            border-color: #adb5bd;
            color: #495057;
        }
        
        .collapsible-content {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid #dee2e6;
        }
        
        .mobile-stats {
            background: #f8f9fa;
            border-radius: 0.25rem;
            padding: 0.5rem;
            text-align: center;
            font-size: 0.85rem;
        }
        
        .mobile-action-btn {
            font-size: 0.8rem;
            padding: 0.375rem 0.75rem;
            width: 100%;
            margin-bottom: 0.5rem;
        }
    }
    
    /* Hide desktop header on mobile */
    @media (max-width: 768px) {
        .desktop-header {
            display: none !important;
        }
    }
    
    /* Hide mobile header on desktop */
    @media (min-width: 769px) {
        .mobile-header {
            display: none !important;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // Pass products data from Django template to JavaScript
    const wasteProducts = [
        {% for product in waste_products %}
        {
            id: {{ product.id }},
            name: "{{ product.name|escapejs }}",
            category: "{{ product.main_category.name|escapejs }}{% if product.sub_category %} - {{ product.sub_category.name|escapejs }}{% endif %}"
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    
    // Load products when waste modal is opened (override the base template function)
    function loadProductsForWaste() {
        const productSelect = document.getElementById('product_id');
        productSelect.innerHTML = '<option value="">Select Product</option>';
        
        wasteProducts.forEach(product => {
            const option = document.createElement('option');
            option.value = product.id;
            option.textContent = `${product.name} (${product.category})`;
            productSelect.appendChild(option);
        });
    }
</script>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <!-- Desktop Header - Only visible on larger screens -->
            <div class="d-none d-md-flex justify-content-between align-items-center mb-4 desktop-header">
                <h2 class="mb-0">üí∞ Cashier Dashboard</h2>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary btn-sm" onclick="window.location.reload()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <a href="{% url 'cashier:receipt_management' %}" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-receipt"></i> Receipts
                    </a>
                </div>
            </div>
            
            <!-- Filters -->
            <div class="card mb-4" id="filterCard">
                <div class="card-header">
                    <h5 class="mb-0">üîç Filter Orders</h5>
                </div>
                <div class="card-body">
                    <form method="GET" class="row g-3">
                        <div class="col-md-3">
                            <label for="table" class="form-label">Table Number</label>
                            <select name="table" id="table" class="form-select">
                                <option value="">All Tables</option>
                                {% for table in tables %}
                                    <option value="{{ table.tbl_no }}" {% if table_filter == table.tbl_no %}selected{% endif %}>
                                        Table {{ table.tbl_no }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="status" class="form-label">Payment Status</label>
                            <select name="status" id="status" class="form-select">
                                <option value="">All Status</option>
                                {% for value, display in payment_status_choices %}
                                    <option value="{{ value }}" {% if status_filter == value %}selected{% endif %}>
                                        {{ display }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary me-2">Filter</button>
                            <a href="{% url 'cashier:dashboard' %}" class="btn btn-outline-secondary">Clear</a>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Orders Table -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">üìã Orders</h5>
                    <span class="badge bg-info">{{ orders|length }} order{{ orders|length|pluralize }}</span>
                </div>
                <div class="card-body">
                    {% if orders %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>SN</th>
                                        <th>Order #</th>
                                        <th>Table</th>
                                        <th>Items</th>
                                        <th>Total</th>
                                        <th>Paid</th>
                                        <th>Balance</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for order in orders %}
                                        <tr class="{% if order.is_fully_paid %}table-success{% elif order.total_paid > 0 %}table-warning{% endif %}">
                                            <td>{{ forloop.counter }}</td>
                                            <td>
                                                <strong>{{ order.order_number }}</strong>
                                                <br>
                                                <small class="text-muted">{{ order.created_at|date:"M d, H:i" }}</small>
                                            </td>
                                            <td>
                                                <span class="badge bg-secondary">Table {{ order.table_info.tbl_no }}</span>
                                            </td>
                                            <td>
                                                <span class="badge bg-info">{{ order.get_total_products }} item{{ order.get_total_products|pluralize }}</span>
                                                <div class="small text-muted mt-1">
                                                    {% for item in order.order_items.all|slice:":2" %}
                                                        {{ item.quantity }}x {{ item.product.name }}<br>
                                                    {% endfor %}
                                                    {% if order.order_items.count > 2 %}
                                                        <span class="text-muted">+ {{ order.order_items.count|add:"-2" }} more...</span>
                                                    {% endif %}
                                                </div>
                                            </td>
                                            <td>
                                                <strong>${{ order.total_amount }}</strong>
                                            </td>
                                            <td>
                                                <span class="text-success">${{ order.total_paid }}</span>
                                            </td>
                                            <td>
                                                {% if order.balance_due > 0 %}
                                                    <span class="text-danger">${{ order.balance_due }}</span>
                                                {% else %}
                                                    <span class="text-success">$0.00</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if order.payment_status == 'paid' %}
                                                    <span class="badge bg-success">Paid</span>
                                                {% elif order.payment_status == 'partial' %}
                                                    <span class="badge bg-warning">Partial</span>
                                                {% else %}
                                                    <span class="badge bg-danger">Unpaid</span>
                                                {% endif %}
                                                <br>
                                                {% if order.status == 'cancelled' %}
                                                    <span class="badge bg-secondary mt-1">Cancelled</span>
                                                {% else %}
                                                    <span class="badge bg-primary mt-1">{{ order.get_status_display }}</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div class="btn-group-vertical btn-group-sm" role="group">
                                                    {% if order.status != 'cancelled' and order.balance_due > 0 %}
                                                        <button type="button" class="btn btn-success btn-sm" onclick="processPayment({{ order.id }})">
                                                            üí≥ Pay
                                                        </button>
                                                    {% endif %}
                                                    
                                                    {% if order.total_paid > 0 %}
                                                        <button type="button" class="btn btn-info btn-sm" onclick="viewPaymentHistory({{ order.id }})">
                                                            üìä History
                                                        </button>
                                                    {% endif %}
                                                    
                                                    {% if order.status != 'cancelled' and order.total_paid == 0 %}
                                                        <button type="button" class="btn btn-danger btn-sm" onclick="cancelOrder({{ order.id }})">
                                                            ‚ùå Cancel
                                                        </button>
                                                    {% endif %}
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <div class="text-muted">
                                <i class="fas fa-receipt fa-3x mb-3"></i>
                                <h5>No orders found</h5>
                                <p>No orders match your current filters.</p>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Payment Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">üí≥ Process Payment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="paymentModalContent">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Payment History Modal -->
<div class="modal fade" id="historyModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">üìä Payment History</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="historyModalContent">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Cancel Order Modal -->
<div class="modal fade" id="cancelModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">‚ùå Cancel Order</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to cancel this order?</p>
                <div class="mb-3">
                    <label for="cancelReason" class="form-label">Reason for cancellation:</label>
                    <textarea class="form-control" id="cancelReason" rows="3" placeholder="Enter reason..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-danger" id="confirmCancel">Cancel Order</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentOrderId = null;
let currentPaymentId = null;

function processPayment(orderId) {
    currentOrderId = orderId;
    const modal = new bootstrap.Modal(document.getElementById('paymentModal'));
    
    fetch(`/cashier/process-payment/${orderId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
                return;
            }
            
            document.getElementById('paymentModalContent').innerHTML = `
                <div class="order-summary mb-4">
                    <h6>Order Details</h6>
                    <div class="row">
                        <div class="col-sm-6">
                            <strong>Order:</strong> ${data.order_number}<br>
                            <strong>Table:</strong> ${data.table_number}
                        </div>
                        <div class="col-sm-6 text-end">
                            <strong>Total:</strong> $${data.total_amount}<br>
                            <strong>Balance Due:</strong> <span class="text-danger">$${data.balance_due}</span>
                        </div>
                    </div>
                </div>
                
                <form id="paymentForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="paymentAmount" class="form-label">Payment Amount</label>
                            <input type="number" class="form-control" id="paymentAmount" 
                                   step="0.01" min="0.01" max="${data.balance_due}" 
                                   value="${data.balance_due}" required>
                        </div>
                        <div class="col-md-6">
                            <label for="paymentMethod" class="form-label">Payment Method</label>
                            <select class="form-select" id="paymentMethod" required>
                                <option value="cash">Cash</option>
                                <option value="card">Card</option>
                                <option value="digital">Digital Payment</option>
                                <option value="voucher">Voucher</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="referenceNumber" class="form-label">Reference Number (Optional)</label>
                            <input type="text" class="form-control" id="referenceNumber" 
                                   placeholder="Transaction ref, check #, etc.">
                        </div>
                        <div class="col-md-6">
                            <label for="paymentNotes" class="form-label">Notes (Optional)</label>
                            <input type="text" class="form-control" id="paymentNotes" 
                                   placeholder="Additional notes...">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">
                            <input type="checkbox" id="splitBill" onchange="toggleSplitBill()"> 
                            Split Bill - Select Individual Items
                        </label>
                    </div>
                    
                    <div id="itemSelection" style="display: none;">
                        <h6>Select Items to Pay:</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Item</th>
                                        <th>Price</th>
                                        <th>Remaining</th>
                                        <th>Pay Qty</th>
                                        <th>Amount</th>
                                    </tr>
                                </thead>
                                <tbody id="itemsTable">
                                    ${data.items.map(item => `
                                        <tr>
                                            <td>${item.product_name}</td>
                                            <td>$${item.unit_price}</td>
                                            <td>${item.remaining_quantity}</td>
                                            <td>
                                                <input type="number" class="form-control form-control-sm item-quantity" 
                                                       data-item-id="${item.id}" data-unit-price="${item.unit_price}"
                                                       min="0" max="${item.remaining_quantity}" value="0"
                                                       onchange="updateItemTotal()">
                                            </td>
                                            <td class="item-total">$0.00</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-success">Process Payment</button>
                    </div>
                </form>
            `;
            
            modal.show();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading payment form');
        });
    
    // Handle form submission
    document.addEventListener('submit', function(e) {
        if (e.target.id === 'paymentForm') {
            e.preventDefault();
            submitPayment();
        }
    });
}

function toggleSplitBill() {
    const splitBill = document.getElementById('splitBill').checked;
    const itemSelection = document.getElementById('itemSelection');
    const paymentAmount = document.getElementById('paymentAmount');
    
    itemSelection.style.display = splitBill ? 'block' : 'none';
    paymentAmount.readOnly = splitBill;
    
    if (splitBill) {
        updateItemTotal();
    }
}

function updateItemTotal() {
    let total = 0;
    const quantities = document.querySelectorAll('.item-quantity');
    
    quantities.forEach(input => {
        const quantity = parseInt(input.value) || 0;
        const unitPrice = parseFloat(input.dataset.unitPrice);
        const itemTotal = quantity * unitPrice;
        
        const row = input.closest('tr');
        row.querySelector('.item-total').textContent = `$${itemTotal.toFixed(2)}`;
        
        total += itemTotal;
    });
    
    document.getElementById('paymentAmount').value = total.toFixed(2);
}

function submitPayment() {
    const amount = document.getElementById('paymentAmount').value;
    const paymentMethod = document.getElementById('paymentMethod').value;
    const referenceNumber = document.getElementById('referenceNumber').value;
    const notes = document.getElementById('paymentNotes').value;
    const splitBill = document.getElementById('splitBill').checked;
    
    let selectedItems = [];
    if (splitBill) {
        const quantities = document.querySelectorAll('.item-quantity');
        quantities.forEach(input => {
            const quantity = parseInt(input.value) || 0;
            if (quantity > 0) {
                selectedItems.push({
                    id: input.dataset.itemId,
                    quantity: quantity
                });
            }
        });
    }
    
    fetch(`/cashier/process-payment/${currentOrderId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            amount: amount,
            payment_method: paymentMethod,
            reference_number: referenceNumber,
            notes: notes,
            selected_items: selectedItems
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message with receipt option
            const result = confirm(data.message + '\n\nWould you like to generate a receipt?');
            if (result && data.payment_id) {
                // Open receipt in new tab
                window.open(`/cashier/receipt/${data.payment_id}/`, '_blank');
            }
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error processing payment');
    });
}

function viewPaymentHistory(orderId) {
    const modal = new bootstrap.Modal(document.getElementById('historyModal'));
    
    fetch(`/cashier/payment-history/${orderId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
                return;
            }
            
            document.getElementById('historyModalContent').innerHTML = `
                <h6>Order: ${data.order_number}</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Amount</th>
                                <th>Method</th>
                                <th>Processed By</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.payments.map(payment => `
                                <tr class="${payment.is_voided ? 'table-secondary' : ''}">
                                    <td>${payment.created_at}</td>
                                    <td>$${payment.amount}</td>
                                    <td>${payment.payment_method}</td>
                                    <td>${payment.processed_by}</td>
                                    <td>
                                        ${payment.is_voided ? 
                                            '<span class="badge bg-secondary">VOIDED</span>' : 
                                            '<span class="badge bg-success">ACTIVE</span>'
                                        }
                                    </td>
                                    <td>
                                        ${!payment.is_voided ? 
                                            `<div class="btn-group btn-group-sm">
                                                <button class="btn btn-danger" onclick="voidPayment(${payment.id})">Void</button>
                                                <button class="btn btn-info" onclick="generateReceipt(${payment.id})">Receipt</button>
                                            </div>` : 
                                            `<button class="btn btn-sm btn-secondary" onclick="generateReceipt(${payment.id})">View Receipt</button>`
                                        }
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            modal.show();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading payment history');
        });
}

function voidPayment(paymentId) {
    const reason = prompt('Enter reason for voiding this payment:');
    if (!reason) return;
    
    const refundMethod = prompt('Refund method (cash/card/digital/voucher):', 'cash');
    if (!refundMethod) return;
    
    fetch(`/cashier/void-payment/${paymentId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            reason: reason,
            refund_method: refundMethod
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error voiding payment');
    });
}

function cancelOrder(orderId) {
    currentOrderId = orderId;
    const modal = new bootstrap.Modal(document.getElementById('cancelModal'));
    modal.show();
    
    document.getElementById('confirmCancel').onclick = function() {
        const reason = document.getElementById('cancelReason').value;
        
        fetch(`/cashier/cancel-order/${orderId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                reason: reason
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error cancelling order');
        });
    };
}

function generateReceipt(paymentId) {
    // Open receipt in new tab
    window.open(`/cashier/receipt/${paymentId}/`, '_blank');
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

<!-- Waste Recording Modal -->
<div class="modal fade" id="wasteRecordModal" tabindex="-1" aria-labelledby="wasteRecordModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-gradient-danger text-white">
                <h5 class="modal-title" id="wasteRecordModalLabel">
                    <i class="fas fa-trash-alt me-2"></i>Record Food Waste
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="wasteForm">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="product" class="form-label">Product <span class="text-danger">*</span></label>
                                <select class="form-select" id="product" name="product" required>
                                    <option value="">Select a product...</option>
                                    {% for product in waste_products %}
                                        <option value="{{ product.id }}">{{ product.name }} - ${{ product.price }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="quantity" class="form-label">Quantity Wasted <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="quantity" name="quantity" min="1" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="waste_reason" class="form-label">Reason <span class="text-danger">*</span></label>
                                <select class="form-select" id="waste_reason" name="waste_reason" required>
                                    <option value="">Select reason...</option>
                                    <option value="customer_refused">Customer Refused</option>
                                    <option value="customer_left">Customer Left Before Pickup</option>
                                    <option value="wrong_order">Wrong Order Made</option>
                                    <option value="quality_issue">Quality Issue</option>
                                    <option value="kitchen_error">Kitchen Error</option>
                                    <option value="overcooking">Overcooking</option>
                                    <option value="undercooking">Undercooking</option>
                                    <option value="contamination">Food Contamination</option>
                                    <option value="other">Other Reason</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="disposal_method" class="form-label">Disposal Method</label>
                                <select class="form-select" id="disposal_method" name="disposal_method">
                                    <option value="waste_bin">Waste Bin</option>
                                    <option value="staff_meal">Staff Meal</option>
                                    <option value="compost">Compost</option>
                                    <option value="donated">Donated</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes (Optional)</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3" placeholder="Additional details about the waste incident..."></textarea>
                    </div>
                </form>
                
                <!-- Recent Records -->
                <div class="mt-4">
                    <h6 class="border-bottom pb-2 mb-3">Recent Records</h6>
                    <div id="recentRecords">
                        <p class="text-muted">Your recent waste records will appear here...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-danger" id="submitWasteForm">
                    <i class="fas fa-save me-1"></i> Record Waste
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="wasteSuccessModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-check-circle me-2"></i>Success
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <p>Waste recorded successfully!</p>
                <div id="wasteSuccessDetails" class="mt-3"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

<script>
// Waste Recording Modal functionality
$(document).ready(function() {
    // Open waste recording modal
    $('#openWasteModal').on('click', function() {
        $('#wasteRecordModal').modal('show');
    });
    
    // Submit waste form
    $('#submitWasteForm').on('click', function() {
        if (!$('#wasteForm')[0].checkValidity()) {
            $('#wasteForm')[0].reportValidity();
            return;
        }
        
        // Collect form data
        const productId = $('#product').val();
        const quantity = $('#quantity').val();
        const wasteReason = $('#waste_reason').val();
        const disposalMethod = $('#disposal_method').val();
        const notes = $('#notes').val();
        
        // Submit data via AJAX
        $.ajax({
            url: "{% url 'waste_management:record_waste' %}",
            type: "POST",
            dataType: "json",
            contentType: "application/json",
            data: JSON.stringify({
                product_id: productId,
                quantity_wasted: quantity,
                waste_reason: wasteReason,
                disposal_method: disposalMethod,
                notes: notes
            }),
            headers: {
                "X-CSRFToken": getCookie("csrftoken")
            },
            success: function(data) {
                // Show success message
                $('#wasteSuccessDetails').html(`
                    <div class="alert alert-light border text-start">
                        <strong>${data.waste_log.product_name}</strong><br>
                        Quantity: ${data.waste_log.quantity_wasted}<br>
                        Total Cost: $${data.waste_log.total_cost.toFixed(2)}<br>
                        Reason: ${data.waste_log.waste_reason}
                    </div>
                `);
                
                // Close waste modal and show success
                $('#wasteRecordModal').modal('hide');
                $('#wasteSuccessModal').modal('show');
                
                // Reset form
                $('#wasteForm')[0].reset();
                
                // Update recent records
                loadRecentRecords();
            },
            error: function(xhr, status, error) {
                let errorMessage = "An error occurred while recording waste.";
                
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMessage = xhr.responseJSON.error;
                }
                
                // Show error message
                alert(errorMessage);
            }
        });
    });
    
    // Load recent records
    function loadRecentRecords() {
        $.ajax({
            url: "/waste-management/api/recent-records/",
            type: "GET",
            success: function(data) {
                if (data.records && data.records.length > 0) {
                    let html = '<div class="list-group list-group-flush small">';
                    data.records.forEach(function(record) {
                        html += `
                            <div class="list-group-item px-0">
                                <div class="d-flex justify-content-between">
                                    <span><strong>${record.product_name}</strong> √ó ${record.quantity}</span>
                                    <span class="text-danger">$${record.cost.toFixed(2)}</span>
                                </div>
                                <small class="text-muted d-block">${record.reason} ‚Ä¢ ${record.date}</small>
                            </div>
                        `;
                    });
                    html += '</div>';
                    $('#recentRecords').html(html);
                } else {
                    $('#recentRecords').html('<p class="text-muted">No recent waste records found.</p>');
                }
            },
            error: function() {
                $('#recentRecords').html('<p class="text-danger">Failed to load recent records.</p>');
            }
        });
    }
    
    // Initial load of recent records
    // loadRecentRecords();
    
    // Waste Products Data for Modal
    const wasteProducts = [
        {% for product in waste_products %}
        {
            id: {{ product.id }},
            name: "{{ product.name|escapejs }}",
            category: "{{ product.main_category.name|escapejs }}{% if product.sub_category %} - {{ product.sub_category.name|escapejs }}{% endif %}"
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    
    // Override the loadProductsForWaste function from base template
    window.loadProductsForWaste = function() {
        const productSelect = document.getElementById('product_id');
        if (!productSelect) return;
        
        productSelect.innerHTML = '<option value="">Select Product</option>';
        
        wasteProducts.forEach(product => {
            const option = document.createElement('option');
            option.value = product.id;
            option.textContent = `${product.name} (${product.category})`;
            productSelect.appendChild(option);
        });
        
        console.log('Loaded', wasteProducts.length, 'products for waste recording');
    };
});
</script>