{% extends 'base.html' %}

{% block title %}Order #{{ order.order_number }} - Track Your Order{% endblock %}

{% block extra_css %}
<style>
.progress-container {
    position: relative;
    margin: 2rem 0;
}

.progress-step {
    display: flex;
    align-items: center;
    margin-bottom: 1.5rem;
    position: relative;
}

.progress-step::after {
    content: '';
    position: absolute;
    left: 1.25rem;
    top: 2.5rem;
    width: 2px;
    height: 2rem;
    background-color: #dee2e6;
    z-index: 1;
}

.progress-step:last-child::after {
    display: none;
}

.progress-step.completed::after {
    background-color: #198754;
}

.progress-step.active::after {
    background-color: #0d6efd;
}

.step-icon {
    width: 2.5rem;
    height: 2.5rem;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
    position: relative;
    z-index: 2;
    font-size: 1rem;
}

.step-icon.completed {
    background-color: #198754;
    color: white;
}

.step-icon.active {
    background-color: #0d6efd;
    color: white;
    animation: pulse 2s infinite;
}

.step-icon.pending {
    background-color: #e9ecef;
    color: #6c757d;
    border: 2px solid #dee2e6;
}

@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(13, 110, 253, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(13, 110, 253, 0); }
    100% { box-shadow: 0 0 0 0 rgba(13, 110, 253, 0); }
}

.step-content h6 {
    margin-bottom: 0.25rem;
    font-weight: 600;
}

.step-content small {
    color: #6c757d;
}

.payment-status {
    border-left: 4px solid;
    padding-left: 1rem;
}

.payment-status.warning {
    border-color: #ffc107;
    background-color: #fff3cd;
}

.payment-status.info {
    border-color: #0dcaf0;
    background-color: #d1ecf1;
}

.payment-status.success {
    border-color: #198754;
    background-color: #d1e7dd;
}

.order-timeline {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 0.5rem;
    padding: 1.5rem;
}

/* Simple Mobile Fix */
@media (max-width: 768px) {
    .progress-step {
        display: table !important;
        width: 100% !important;
        margin-bottom: 15px !important;
        padding: 15px !important;
        background: #f8f9fa !important;
        border-radius: 8px !important;
    }
    
    .step-icon {
        display: table-cell !important;
        width: 50px !important;
        height: 50px !important;
        vertical-align: middle !important;
        text-align: center !important;
        border-radius: 50% !important;
        background-color: inherit !important;
        font-size: 1.2rem !important;
        line-height: 50px !important;
    }
    
    .step-content {
        display: table-cell !important;
        vertical-align: middle !important;
        padding-left: 15px !important;
        -webkit-font-smoothing: antialiased !important;
        -moz-osx-font-smoothing: grayscale !important;
        text-rendering: optimizeLegibility !important;
    }
    
    .step-content h6 {
        color: black !important;
        font-weight: 600 !important;
        font-size: 1rem !important;
        line-height: 1.3 !important;
        margin-bottom: 4px !important;
        -webkit-font-smoothing: antialiased !important;
        -moz-osx-font-smoothing: grayscale !important;
    }
    
    .step-content small {
        color: black !important;
        font-size: 0.875rem !important;
        line-height: 1.4 !important;
        -webkit-font-smoothing: antialiased !important;
        -moz-osx-font-smoothing: grayscale !important;
    }
    
    .step-content .text-primary {
        color: #0d6efd !important;
        font-weight: bold !important;
    }
    
    .progress-step::after {
        display: none !important;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="customer-tracking" data-order-id="{{ order.id }}" data-user-id="{{ user.id }}">
    <!-- Live Tracking Indicator -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h4 mb-0">Track Your Order</h1>
        <span class="live-indicator">LIVE TRACKING</span>
    </div>

    <div class="row">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'orders:my_orders' %}">My Orders</a></li>
                <li class="breadcrumb-item active">Order #{{ order.order_number }}</li>
            </ol>
        </nav>
    </div>
</div>

<!-- Order Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h3 class="mb-1">
                            <i class="bi bi-receipt text-primary"></i>
                            Order #{{ order.order_number }}
                        </h3>
                        <p class="text-muted mb-0">
                            <i class="bi bi-calendar3"></i>
                            Placed on {{ order.created_at|date:"F d, Y \a\t H:i" }}
                        </p>
                    </div>
                    <div class="col-md-6 text-md-end">
                        <div class="d-flex flex-column align-items-md-end">
                            <div class="mb-2">
                                <span class="badge fs-6
                                    {% if order.status == 'pending' %}bg-warning
                                    {% elif order.status == 'confirmed' %}bg-info
                                    {% elif order.status == 'preparing' %}bg-primary
                                    {% elif order.status == 'ready' %}bg-success
                                    {% elif order.status == 'served' %}bg-secondary
                                    {% elif order.status == 'cancelled' %}bg-danger
                                    {% endif %}">
                                    {% if order.status == 'cancelled' %}Order Cancelled{% else %}{{ order.get_status_display }}{% endif %}
                                </span>
                            </div>
                            <div class="payment-status {{ payment_info.class }} p-2 rounded">
                                <i class="{{ payment_info.icon }} me-1"></i>
                                {{ payment_info.label }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Order Tracking Timeline -->
    <div class="col-lg-8">
        <div class="card shadow-sm mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-clock-history text-primary"></i>
                    Order Progress
                </h5>
            </div>
            <div class="card-body">
                {% if is_cancelled %}
                    <div class="alert alert-danger">
                        <i class="bi bi-x-circle-fill me-2"></i>
                        <strong>Order Cancelled</strong>
                        {% if order.reason_if_cancelled %}
                            <br><small>Reason: {{ order.reason_if_cancelled }}</small>
                        {% endif %}
                    </div>
                {% else %}
                    <div class="order-timeline">
                        <div class="progress-container">
                            {% for step in status_progress %}
                                <div class="progress-step {% if forloop.counter0 < completed_steps %}completed{% elif forloop.counter0 == current_step %}active{% endif %}">
                                    <div class="step-icon {% if forloop.counter0 < completed_steps %}completed{% elif forloop.counter0 == current_step %}active{% else %}pending{% endif %}">
                                        <i class="{{ step.icon }}"></i>
                                    </div>
                                    <div class="step-content">
                                        <h6>{{ step.label }}</h6>
                                        <small>{{ step.description }}</small>
                                        {% if forloop.counter0 == current_step %}
                                            <div class="mt-1">
                                                <small class="text-primary fw-bold">Current Status</small>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        
                        {% if order.status == 'served' and order.payment_status != 'paid' %}
                            <div class="alert alert-info mt-3">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>Order Complete!</strong> Please proceed to payment to finalize your order.
                            </div>
                        {% elif order.status == 'served' and order.payment_status == 'paid' %}
                            <div class="alert alert-success mt-3">
                                <i class="bi bi-check-circle-fill me-2"></i>
                                <strong>All Done!</strong> Thank you for dining with us. Enjoy your meal!
                            </div>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Order Items -->
        <div class="card shadow-sm">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-basket text-primary"></i>
                    Order Items
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead class="table-light">
                            <tr>
                                <th>Item</th>
                                <th class="text-center">Qty</th>
                                <th class="text-end">Price</th>
                                <th class="text-end">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in order.order_items.all %}
                            <tr>
                                <td>
                                    <strong>{{ item.product.name }}</strong>
                                    {% if item.special_notes %}
                                        <br><small class="text-muted">Note: {{ item.special_notes }}</small>
                                    {% endif %}
                                </td>
                                <td class="text-center">{{ item.quantity }}</td>
                                <td class="text-end">${{ item.unit_price }}</td>
                                <td class="text-end"><strong>${{ item.get_subtotal }}</strong></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="table-light">
                            <tr>
                                <th colspan="3" class="text-end">Total Amount:</th>
                                <th class="text-end">${{ order.total_amount }}</th>
                            </tr>
                            {% if order.payment_amount %}
                            <tr>
                                <th colspan="3" class="text-end">Paid Amount:</th>
                                <th class="text-end">${{ order.payment_amount }}</th>
                            </tr>
                            {% if order.payment_status != 'paid' %}
                            <tr>
                                <th colspan="3" class="text-end">Remaining:</th>
                                <th class="text-end">${{ order.total_amount|add:order.payment_amount|add:"-"|floatformat:2 }}</th>
                            </tr>
                            {% endif %}
                            {% endif %}
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Summary Sidebar -->
    <div class="col-lg-4">
        <div class="card shadow-sm mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-info-circle text-primary"></i>
                    Order Information
                </h5>
            </div>
            <div class="card-body">
                <table class="table table-sm table-borderless">
                    <tr>
                        <td><strong>Table:</strong></td>
                        <td class="text-end">{{ order.table_info.tbl_no }}</td>
                    </tr>
                    <tr>
                        <td><strong>Items:</strong></td>
                        <td class="text-end">{{ order.get_total_products }}</td>
                    </tr>
                    <tr>
                        <td><strong>Total:</strong></td>
                        <td class="text-end"><strong>${{ order.total_amount }}</strong></td>
                    </tr>
                    <tr>
                        <td><strong>Payment:</strong></td>
                        <td class="text-end">
                            <span class="badge bg-{{ payment_info.class }}">
                                {{ payment_info.label }}
                            </span>
                        </td>
                    </tr>
                    {% if order.confirmed_by %}
                    <tr>
                        <td><strong>Confirmed by:</strong></td>
                        <td class="text-end">{{ order.confirmed_by.get_full_name|default:order.confirmed_by.username }}</td>
                    </tr>
                    {% endif %}
                </table>
                
                {% if order.special_instructions %}
                    <div class="mt-3">
                        <strong>Special Instructions:</strong>
                        <p class="mt-1 mb-0 small">{{ order.special_instructions }}</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card shadow-sm">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-lightning text-primary"></i>
                    Quick Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{% url 'orders:my_orders' %}" class="btn btn-outline-primary">
                        <i class="bi bi-arrow-left"></i> Back to My Orders
                    </a>
                    {% if order.status == 'pending' %}
                        <a href="{% url 'orders:customer_cancel_order' order.id %}" class="btn btn-outline-danger">
                            <i class="bi bi-x-circle"></i> Cancel Order
                        </a>
                    {% elif order.status == 'confirmed' or order.status == 'preparing' or order.status == 'ready' %}
                        <div class="alert alert-info mb-2">
                            <i class="bi bi-info-circle"></i> 
                            <small>Order cannot be cancelled as it has been confirmed by the kitchen.</small>
                        </div>
                    {% endif %}
                    {% if order.status == 'served' and order.payment_status != 'paid' %}
                        <button class="btn btn-success">
                            <i class="bi bi-credit-card"></i> Proceed to Payment
                        </button>
                    {% endif %}
                    <a href="{% url 'orders:select_table' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-plus-circle"></i> Place New Order
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
</div> <!-- End customer-tracking wrapper -->
{% endblock %}